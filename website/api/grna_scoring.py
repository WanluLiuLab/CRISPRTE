"""
gRNA scoring for 20bp gRNA sequence

1.Mendoza, B. J. & Trinh, C. T. Enhanced guide-RNA design and targeting analysis for precise CRISPR genome editing of single and consortia of industrially relevant and non-model organisms. Bioinformatics 34, 16–23 (2018).
2.Moreno-Mateos, M. A. et al. CRISPRscan: designing highly efficient sgRNAs for CRISPR-Cas9 targeting in vivo. Nat Methods 12, 982–988 (2015).

"""

import numpy as np

from typing import List

from .azimuth.model_comparison import predict
from .addtag.morenomateos import MorenoMateos

Moreno = MorenoMateos()

def calculate_moreno_mateos(target:str, pam:str, upstream:str, downstream:str):
	return Moreno.calculate(target, pam, upstream, downstream)

def calculate_azimuth(sequences:list):
	return predict(np.array(sequences))


mononucleotide_features_pen = {'A':-0.5,'G':1,'C':.5,'T':0}

mononucleotide_features_col = {'A':0,'T':1,'C':2,'G':3,'M':4,'R':5,'W':6,'S':7,'Y':8,'K':9,'V':10,'H':11,'D':12,'B':13,'N':14}
mononucleotide_features = \
       np.array([[ 0.        ,  0.        ,  0.        , -0.0297    ,  0.        ,
        -0.01485   ,  0.        , -0.01485   ,  0.        , -0.01485   ,
        -0.0099    ,  0.        , -0.0099    , -0.0099    ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [-0.0422    ,  0.        ,  0.        ,  0.        , -0.0211    ,
        -0.0211    , -0.0211    ,  0.        ,  0.        ,  0.        ,
        -0.01406667, -0.01406667, -0.01406667,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.0024    ,  0.1146    ,  0.0012    ,
         0.0573    ,  0.        ,  0.0585    ,  0.0012    ,  0.0573    ,
         0.039     ,  0.0008    ,  0.0382    ,  0.039     ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.0677    ,  0.        ,
         0.03385   ,  0.        ,  0.03385   ,  0.        ,  0.03385   ,
         0.02256667,  0.        ,  0.02256667,  0.02256667,  0.        ],
       [-0.0183    ,  0.        ,  0.        ,  0.0209    , -0.00915   ,
         0.0013    , -0.00915   ,  0.01045   ,  0.        ,  0.01045   ,
         0.00086667, -0.0061    ,  0.00086667,  0.00696667,  0.        ],
       [ 0.0116    ,  0.        ,  0.        ,  0.0276    ,  0.0058    ,
         0.0196    ,  0.0058    ,  0.0138    ,  0.        ,  0.0138    ,
         0.01306667,  0.00386667,  0.01306667,  0.0092    ,  0.        ],
       [ 0.0176    ,  0.0354    ,  0.0695    ,  0.0614    ,  0.04355   ,
         0.0395    ,  0.0265    ,  0.06545   ,  0.05245   ,  0.0484    ,
         0.0495    ,  0.04083333,  0.03813333,  0.05543333,  0.        ],
       [-0.0185    ,  0.        ,  0.        ,  0.0251    , -0.00925   ,
         0.0033    , -0.00925   ,  0.01255   ,  0.        ,  0.01255   ,
         0.0022    , -0.00616667,  0.0022    ,  0.00836667,  0.        ],
       [-0.0106    ,  0.        , -0.0005    ,  0.0511    , -0.00555   ,
         0.02025   , -0.0053    ,  0.0253    , -0.00025   ,  0.02555   ,
         0.01333333, -0.0037    ,  0.0135    ,  0.01686667,  0.        ],
       [ 0.        ,  0.        , -0.0216    ,  0.038     , -0.0108    ,
         0.019     ,  0.        ,  0.0082    , -0.0108    ,  0.019     ,
         0.00546667, -0.0072    ,  0.01266667,  0.00546667,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.0155    ,  0.        ,
         0.00775   ,  0.        ,  0.00775   ,  0.        ,  0.00775   ,
         0.00516667,  0.        ,  0.00516667,  0.00516667,  0.        ],
       [-0.0338    ,  0.        ,  0.        ,  0.0165    , -0.0169    ,
        -0.00865   , -0.0169    ,  0.00825   ,  0.        ,  0.00825   ,
        -0.00576667, -0.01126667, -0.00576667,  0.0055    ,  0.        ],
       [-0.0156    ,  0.        ,  0.        ,  0.0179    , -0.0078    ,
         0.00115   , -0.0078    ,  0.00895   ,  0.        ,  0.00895   ,
         0.00076667, -0.0052    ,  0.00076667,  0.00596667,  0.        ],
       [ 0.        ,  0.        ,  0.0151    ,  0.034     ,  0.00755   ,
         0.017     ,  0.        ,  0.02455   ,  0.00755   ,  0.017     ,
         0.01636667,  0.00503333,  0.01133333,  0.01636667,  0.        ],
       [ 0.        , -0.0687    ,  0.0343    ,  0.        ,  0.01715   ,
         0.        , -0.03435   ,  0.01715   , -0.0172    , -0.03435   ,
         0.01143333, -0.01146667, -0.0229    , -0.01146667,  0.        ],
       [ 0.0319    ,  0.0132    ,  0.0376    ,  0.1011    ,  0.03475   ,
         0.0665    ,  0.02255   ,  0.06935   ,  0.0254    ,  0.05715   ,
         0.05686667,  0.02756667,  0.04873333,  0.05063333,  0.        ],
       [ 0.        , -0.0014    ,  0.        ,  0.        ,  0.        ,
         0.        , -0.0007    ,  0.        , -0.0007    , -0.0007    ,
         0.        , -0.00046667, -0.00046667, -0.00046667,  0.        ],
       [ 0.0375    , -0.012     ,  0.053     ,  0.1055    ,  0.04525   ,
         0.0715    ,  0.01275   ,  0.07925   ,  0.0205    ,  0.04675   ,
         0.06533333,  0.02616667,  0.04366667,  0.04883333,  0.        ],
       [ 0.0105    ,  0.        , -0.0316    ,  0.        , -0.01055   ,
         0.00525   ,  0.00525   , -0.0158    , -0.0158    ,  0.        ,
        -0.00703333, -0.00703333,  0.0035    , -0.01053333,  0.        ],
       [ 0.        ,  0.        , -0.0004    ,  0.0361    , -0.0002    ,
         0.01805   ,  0.        ,  0.01785   , -0.0002    ,  0.01805   ,
         0.0119    , -0.00013333,  0.01203333,  0.0119    ,  0.        ],
       [ 0.0191    , -0.0003    ,  0.0799    ,  0.0852    ,  0.0495    ,
         0.05215   ,  0.0094    ,  0.08255   ,  0.0398    ,  0.04245   ,
         0.0614    ,  0.0329    ,  0.03466667,  0.05493333,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        ,  0.0173    , -0.0132    , -0.0463    , -0.0066    ,
        -0.02315   ,  0.00865   , -0.02975   ,  0.00205   , -0.0145    ,
        -0.01983333,  0.00136667, -0.00966667, -0.01406667,  0.        ],
       [ 0.0016    ,  0.        , -0.0307    ,  0.        , -0.01455   ,
         0.0008    ,  0.0008    , -0.01535   , -0.01535   ,  0.        ,
        -0.0097    , -0.0097    ,  0.00053333, -0.01023333,  0.        ],
       [ 0.0124    ,  0.        ,  0.        ,  0.0307    ,  0.0062    ,
         0.02155   ,  0.0062    ,  0.01535   ,  0.        ,  0.01535   ,
         0.01436667,  0.00413333,  0.01436667,  0.01023333,  0.        ],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.        ,  0.        ,  0.        ],
       [ 0.        , -0.0176    ,  0.        , -0.0142    ,  0.        ,
        -0.0071    , -0.0088    , -0.0071    , -0.0088    , -0.0159    ,
        -0.00473333, -0.00586667, -0.0106    , -0.0106    ,  0.        ],
       [ 0.0486    ,  0.        ,  0.        ,  0.        ,  0.0243    ,
         0.0243    ,  0.0243    ,  0.        ,  0.        ,  0.        ,
         0.0162    ,  0.0162    ,  0.0162    ,  0.        ,  0.        ]])

dinucleotides_features_col = dict(zip(["AA", "AT", "AC", "AG", "TA", "TT", "TC", "TG", "CA", "CT", "CC", "CG", "GA", "GT", "GC", "GG"], range(16)))
dinucleotides_features = np.array(\
[[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.0229,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.0247,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.0542, -0.0016],
[-0.0169,  0.    ,  0.    ,  0.0637,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.0268],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0537,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.0419],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.0862,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.0744],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.0534,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0349,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.0944,  0.    ,
  0.0459,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0024,
  0.    ,  0.    ],
[-0.0974,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0097,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.0889,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    , -0.0543,  0.    ,  0.    ,  0.    ,
 -0.0664,  0.    ,  0.    ,  0.0951,  0.    ,  0.    ,  0.1067,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.0622,  0.    ,  0.    ,  0.    ,  0.    ,  0.061 ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
 -0.0735,  0.1116],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    , -0.0843,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.0578,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.0481,  0.    ,  0.    ,  0.    ,  0.    , -0.0123,  0.0734,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    , -0.0419,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.0378,  0.    ,
  0.    ,  0.    ],
[ 0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
  0.    ,  0.    ]])

pam_density_score_table = \
np.array([[ 1.  ,  1.  ,  1.  ,  2.  ,  2.  ,  8.  , 10.  ],
       [ 1.  ,  1.  ,  1.  ,  2.  ,  2.  ,  8.  , 10.  ],
       [ 1.  ,  1.  ,  1.  ,  2.5 ,  2.5 , 10.  ,  0.  ],
       [ 1.  ,  1.  ,  1.66,  2.5 ,  2.5 ,  0.  ,  0.  ],
       [ 1.66,  1.66,  3.33,  3.33,  0.  ,  0.  ,  0.  ],
       [ 2.5 ,  2.5 ,  3.33,  0.  ,  0.  ,  0.  ,  0.  ],
       [ 5.  ,  5.  ,  0.  ,  0.  ,  0.  ,  0.  ,  0.  ]])

def compute_scp_score(grna, pam, upstream, downstream):
    assert(len(grna)==20 and len(pam)==3 and len(upstream) == len(downstream) == 6)
    ## Caculating mono- and di-nucleotide features score
    init_score = 0
    sg_score = 0
    f_pam_count = 0
    r_pam_count = 0
    seq = upstream + grna + pam + downstream
    init_score = 0
    for i in range(35):
        init_score += mononucleotide_features[i][mononucleotide_features_col[seq[i]]]
        if 6 <= i < 26:
            sg_score += mononucleotide_features_pen[seq[i]]
        dinucleotides = seq[i:i+2]
        if dinucleotides in dinucleotides_features_col.keys():
            init_score += dinucleotides_features[i][dinucleotides_features_col[dinucleotides]]
    init_score = round(100 * (init_score + 0.6556) / 1.9497, 2)
    return init_score + sg_score

def compute_sc_score(grna, pam, upstream, downstream, only_seed=False):
    seq = upstream + grna + pam + downstream
    init_score = 0
    for i in range(35) if not only_seed else range(6,26):
        init_score += mononucleotide_features[i][mononucleotide_features_col[seq[i]]]
        dinucleotides = seq[i:i+2]
        if dinucleotides in dinucleotides_features_col.keys():
            init_score += dinucleotides_features[i][dinucleotides_features_col[dinucleotides]]
    init_score = round(100 * (init_score + 0.6556) / 1.9497, 2)
    return init_score